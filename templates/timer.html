<!DOCTYPE html>
<html lang="en">

<head>
    <title>time ur time</title>
    <meta charset="utf-8" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script type="text/javascript" charset="utf-8">
        var distance = 0.5 * 60000;
        var online=1;
        var x;
        var timesession = [0.5 * 60000, 0.1 * 60000, 0.5 * 60000, 0.1 * 60000, 0.5 * 60000, 0.1 * 60000, 0.5 * 60000, 0.1 * 60000];
        var numbersession = 0;

        function countdown(millisec) {
            var countDownDate = new Date().getTime() + millisec;

            // Update the count down every 1 second
            x = setInterval(function() {

                // Get todays date and time
                var now = new Date().getTime();

                // Find the distance between now an the count down date
                distance = countDownDate - now;

                // Time calculations for days, hours, minutes and seconds

                var minutes = (Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).toString();
                var seconds = (Math.floor((distance % (1000 * 60)) / 1000)).toString();

                if (seconds.length === 1) {
                    seconds = '0' + seconds;

                }
                if (minutes.length === 1) {
                    minutes = '0' + minutes;

                }

                // Output the result in an element with id="demo"
                document.getElementById("time").innerHTML = minutes + ":" + seconds;

                // If the count down is over, write some text
                if (distance <= 0) {
                    numbersession += 1;
                    numbersession = numbersession % 8;
                    clearInterval(x);
                    countdown(timesession[numbersession]);
                    document.getElementById("time").innerHTML = "EXPIRED";
                }

            }, 1000);
        }

        console.log("primary session" + numbersession);

        // countdown(timesession[numbersession]);
        function getCurrentTime() {
            return distance;
        }


        $(document).ready(function() {
            // Use a "/test" namespace.
            // An application can open a connection on multiple namespaces, and
            // Socket.IO will multiplex all those connections on a single
            // physical channel. If you don't care about multiple channels, you
            // can set the namespace to an empty string.
            namespace = '/test';

            // Connect to the Socket.IO server.
            // The connection URL has the following format:
            //     http[s]://<domain>:<port>[/<namespace>]
            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);

            // Event handler for new connections.
            // The callback function is invoked when a connection with the
            // server is established.

            socket.emit("create_new")
            socket.on('connect', function() {
                socket.emit('my_event', {
                    data: 'I\'m connected!'
                });
            });
            socket.on('my_response', function(msg) {

                $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
            });

            // Interval function that tests message latency by sending a "ping"
            // message. The server then responds with a "pong" message and the
            // round trip time is measured.
            var ping_pong_times = [];
            var start_time;
            window.setInterval(function() {
                start_time = (new Date).getTime();
                socket.emit('my_ping');
            }, 1000);

            // Handler for the "pong" message. When the pong is received, the
            // time from the ping is stored, and the average of the last 30
            // samples is average and displayed.
            socket.on('my_pong', function() {
                var latency = (new Date).getTime() - start_time;
                ping_pong_times.push(latency);
                ping_pong_times = ping_pong_times.slice(-30); // keep last 30 samples
                var sum = 0;
                for (var i = 0; i < ping_pong_times.length; i++)
                    sum += ping_pong_times[i];
                $('#ping-pong').text(Math.round(10 * sum / ping_pong_times.length) / 10);
            });
            socket.on('timer_syn', function(msg) {
                var current = getCurrentTime();
                console.log('current' + current);
                $('#log').append('<br>' + $('<div/>').text('timer_syn').html());
                socket.emit('gettime', {
                    room: msg.room,
                    currenttime: current,
                    session: numbersession,
                    pause: pause,
                    online:online
                });


            });
            socket.on('disconnection',function(msg){
              console.log('connect'+online);
              online=online-1;
              document.getElementById("onlinenumber").innerHTML = online;
              socket.emit('gettime', {
                  room: msg.room,
                  currenttime: distance,
                  session: numbersession,
                  pause: pause,
                  online:online
              });

            });
            socket.on("new_connection",function(){
              online=online+1;
              document.getElementById("onlinenumber").innerHTML = online;
            });

            socket.on('start_timer', function(msg) {
                //$('#log').append('<br>' + $('<div/>').text('start_timer').html());
                console.log("start time pause" + pause);
                clearInterval(x);
                numbersession = msg.session;
                distance = msg.currenttime;
                document.getElementById("onlinenumber").innerHTML = msg.online;


                if (msg.pause === 'break') {
                    countdown(timesession[msg.session]);
                } else {
                    pause = msg.pause;
                    if (msg.pause) {
                        console.log("pausing");
                        countdown(msg.currenttime);


                    } else {
                        console.log("not pausing");

                        countdown(msg.currenttime);
                        clearInterval(x);
                        var minutes = (Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).toString();
                        var seconds = (Math.floor((distance % (1000 * 60)) / 1000)).toString();
                        document.getElementById("time").innerHTML = minutes + ":" + seconds;


                    }
                }

            });

            // Handlers for the different forms in the page.
            // These accept data from the user and send it to the server in a
            // variety of ways
            $('form#emit').submit(function(event) {
                socket.emit('my_event', {
                    data: $('#emit_data').val()
                });
                return false;
            });
            $('form#broadcast').submit(function(event) {
                socket.emit('my_broadcast_event', {
                    data: $('#broadcast_data').val()
                });
                return false;
            });
            $('form#leave').submit(function(event) {
                socket.emit('leave', {
                    room: $('#leave_room').val()
                });
                return false;
            });
            $('form#send_room').submit(function(event) {
                socket.emit('my_room_event', {
                    room: $('#room_name').val(),
                    data: $('#room_data').val()
                });
                return false;
            });
            $('form#close').submit(function(event) {
                socket.emit('close_room', {
                    room: $('#close_room').val()
                });
                return false;
            });
            $('form#disconnect').submit(function(event) {
                socket.emit('disconnect_request');
                return false;
            });

            $('form#join').submit(function() {
                socket.emit('room_and_time', {
                    room: $('#join_room').val()
                });

                return false;

            });

            $('#takebreak').click(function() {
                numbersession += 1;
                clearInterval(x);
                console.log("break taking");
                countdown(timesession[numbersession]);
                var current = getCurrentTime();
                socket.emit('gettime', {
                    room: window.location.pathname.replace('/',''),
                    session: numbersession,
                    currenttime: current,
                    pause: 'break',
                    online:online
                })
            });

            var pause = false;

            $('#reset').click(function() {
                console.log("reset" + numbersession);
                console.log("sync the pause");
                clearInterval(x);
                countdown(timesession[numbersession]);
                socket.emit('gettime', {
                    room: window.location.pathname.replace('/',''),
                    session: numbersession,
                    currenttime: distance,
                    pause: 'break',
                    online:online
                });
            });
            $('#startbutton').click(function() {
                if (!pause) {
                    console.log("ss");
                    // countdown(distance);
                    pause = true;


                } else {
                    console.log("pause is pressed");
                    // clearInterval(x);

                    pause = false;

                }
                console.log("final pause" + pause);
                socket.emit('gettime', {
                    'currenttime': distance,
                    'session': numbersession,
                    'pause': pause,
                    'room': window.location.pathname.replace('/',''),
                    online :online
                });


            });

        });
    </script>
</head>

<body class>
    <div class="row" id="timer-display">
        <div class="row no-gutters" id="title">
            <div class="col-md-auto col-xs-auto">
                Timetowork
            </div>
        </div>
        <br>
        <div class="row text-center" id="time">
            <!-- <div class="col-md-4"></div>
        <div class="col-md-4 col-xs-1 center-block text-center" id="time"> -->
            00:00
            <!-- </div> -->
            <!-- <div class="col-md-4"></div> -->
        </div>

        <br>
        <img class="center-block" id="startbutton" src="{{url_for('static', filename='startbutton.png')}}" style="height:150px; width=150px;" />
    </div>
    <div class="row">
        <div class="col-md-4 text-center" id="bartext">
            <div class="row">
                Online
            </div>
            <div class="row" style="padding-top:30px;" id="onlinenumber">
                1
            </div>

        </div>
        <div class="col-md-4 text-center" id="bartext">
            <div class="row" id="takeabreak">
                <input type="submit" value="Take a break" class="bottom-button" id="takebreak"> </input>
            </div>
            <div class="row" style="padding-top:40px;">
                <input type="submit" value="Reset" class="bottom-button" id="reset"> </input>
            </div>

        </div>
        <div class="col-md-4 text-center" id="bartext">
            <div class="row">
                <button id="invite" value="Invite" class="bottom-button" id="takebreak" onclick="copyToClipboard(window.location.href);"> Invite</button>
            </div>

        </div>

    </div>
    <div id="snackbar">The link is copied to your clipboard</div>





</body>



<script>
  function copyToClipboard(element) {
    console.log(element);
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val(element).select();
    document.execCommand("copy");
    $temp.remove();
    var x = document.getElementById("snackbar")
    x.className = "show";

    // After 3 seconds, remove the show class from DIV
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}

</script>

<style>
#snackbar {
visibility: hidden; /* Hidden by default. Visible on click */
min-width: 250px; /* Set a default minimum width */
margin-left: -125px; /* Divide value of min-width by 2 */
background-color: #333; /* Black background color */
color: #fff; /* White text color */
text-align: center; /* Centered text */
border-radius: 2px; /* Rounded borders */
padding: 16px; /* Padding */
position: fixed; /* Sit on top of the screen */
z-index: 1; /* Add a z-index if needed */
left: 50%; /* Center the snackbar */
bottom: 30px; /* 30px from the bottom */
}

/* Show the snackbar when clicking on a button (class added with JavaScript) */
#snackbar.show {
visibility: visible; /* Show the snackbar */

/* Add animation: Take 0.5 seconds to fade in and out the snackbar.
However, delay the fade out process for 2.5 seconds */
-webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

/* Animations to fade the snackbar in and out */
@-webkit-keyframes fadein {
from {bottom: 0; opacity: 0;}
to {bottom: 30px; opacity: 1;}
}

@keyframes fadein {
from {bottom: 0; opacity: 0;}
to {bottom: 30px; opacity: 1;}
}

@-webkit-keyframes fadeout {
from {bottom: 30px; opacity: 1;}
to {bottom: 0; opacity: 0;}
}

@keyframes fadeout {
from {bottom: 30px; opacity: 1;}
to {bottom: 0; opacity: 0;}
}
    /*#takeabreak{
  padding-top:4vh;
}*/
    .bottom-button{
      background-color: white;
      border:none;
      outline:none;
    }

    #bartext {
        /* online: */
        border-right: 1px solid #979797;
        font-family: ArialRoundedMTBold;
        font-size: 60px;
        padding-top: 5vh;
        color: rgba(88, 199, 181, 0.73);
        letter-spacing: -0.41px;
    }

    #time {
        /* 00:00: */
        font-family: Arial-Black;
        font-size: 180px;
        color: #FFFFFF;
        letter-spacing: -3.5px;
        line-height: 318px;
        margin-top: 3vh;
    }

    #title {
        /* Timetowork: */
        font-family: HannotateSC-W5;
        font-size: 4vh;
        overflow: hidden;
        color: #45898E;
        letter-spacing: -0.41px;
        padding-left: 3vw;
    }

    #timer-display {
        padding-bottom: 22vh;
        background-color: red;
        /* Rectangle 2: */
        background: #59C7B5;
        border: 1px solid #979797;
    }
</style>



</html>
